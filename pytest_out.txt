...FFFF                                                                  [100%]
================================== FAILURES ===================================
_________________ TestLLMService.test_stream_analysis_success _________________

self = <test_services.TestLLMService object at 0x000001C8175F9950>
service = <src.core.services.LLMService object at 0x000001C81761F8C0>
mock_client = <MagicMock name='Client()' id='1958897382608'>
valid_payload = ResponseRequestPayload(model='gemini-3-pro-preview', input=[InputMessage(role='user', content=[InputTextContent(type='...text='Test input')])], instructions='System prompt', thinking=None, tools=None, previous_response_id=None, stream=True)

    @pytest.mark.asyncio
    async def test_stream_analysis_success(self, service, mock_client, valid_payload):
        """
        Verifies a successful streaming session with text deltas and usage stats.
        """
        usage_mock = MagicMock()
        usage_mock.prompt_token_count = 10
        usage_mock.candidates_token_count = 5
        usage_mock.total_token_count = 15
        usage_mock.cached_content_token_count = 2
    
        mock_events = [
            self._create_mock_chunk(text="Hello "),
            self._create_mock_chunk(text="World", usage=usage_mock)
        ]
    
        mock_client.aio.models.generate_content_stream = AsyncMock(
            return_value=self._mock_async_generator(mock_events)
        )
    
        results = [res async for res in service.stream_analysis(valid_payload)]
    
        # 1 ResponseCreated, 2 TextDelta, 1 StreamUsage = 4 total events
>       assert len(results) == 4
E       assert 5 == 4
E        +  where 5 = len([StreamResponseCreated(response_id='gemini-stream'), StreamTextDelta(delta='Hello '), StreamTextDelta(delta='World'), ...=2), StreamError(message="\n[Stream Error] ストリーム処理中にエラーが発生しました: object MagicMock can't be used in 'await' expression")])

tests\test_services.py:136: AssertionError
------------------------------ Captured log call ------------------------------
ERROR    src.core.services:services.py:232 Error during stream iteration
Traceback (most recent call last):
  File "E:\Python\syukatsu_Support\src\core\services.py", line 190, in _execute_api_call
    async with self.get_async_client() as client:
               ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 221, in __aexit__
    await anext(self.gen)
  File "E:\Python\syukatsu_Support\src\core\base.py", line 61, in get_async_client
    await client.aio.aclose()
TypeError: object MagicMock can't be used in 'await' expression
__________ TestLLMService.test_stream_analysis_api_connection_error ___________

self = <test_services.TestLLMService object at 0x000001C8175F9BD0>
service = <src.core.services.LLMService object at 0x000001C8175F9F90>
mock_client = <MagicMock name='Client()' id='1958898176016'>
valid_payload = ResponseRequestPayload(model='gemini-3-pro-preview', input=[InputMessage(role='user', content=[InputTextContent(type='...text='Test input')])], instructions='System prompt', thinking=None, tools=None, previous_response_id=None, stream=True)

    @pytest.mark.asyncio
    async def test_stream_analysis_api_connection_error(self, service, mock_client, valid_payload):
        """Verifies handling of API errors."""
        mock_client.aio.models.generate_content_stream.side_effect = genai_errors.APIError(500, {"message": "Connection failed"})
    
        results = [res async for res in service.stream_analysis(valid_payload)]
    
        assert len(results) == 1
        assert isinstance(results[0], StreamError)
>       assert "Connection failed" in results[0].message
E       assert 'Connection failed' in "\n[Stream Error] ストリーム処理中にエラーが発生しました: object MagicMock can't be used in 'await' expression"
E        +  where "\n[Stream Error] ストリーム処理中にエラーが発生しました: object MagicMock can't be used in 'await' expression" = StreamError(message="\n[Stream Error] ストリーム処理中にエラーが発生しました: object MagicMock can't be used in 'await' expression").message

tests\test_services.py:160: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  src.core.services:before_sleep.py:64 Retrying src.core.services.LLMService._create_stream in 0.772 seconds as it raised APIError: 500 None. {'message': 'Connection failed'}.
WARNING  src.core.services:before_sleep.py:64 Retrying src.core.services.LLMService._create_stream in 0.754 seconds as it raised APIError: 500 None. {'message': 'Connection failed'}.
ERROR    src.core.services:services.py:232 Error during stream iteration
Traceback (most recent call last):
  File "E:\Python\syukatsu_Support\src\core\base.py", line 58, in get_async_client
    yield client
  File "E:\Python\syukatsu_Support\src\core\services.py", line 191, in _execute_api_call
    stream = await self._create_stream(client, payload)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 193, in async_wrapped
    return await copy(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 112, in __call__
    do = await self.iter(retry_state=retry_state)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 157, in iter
    result = await action(retry_state)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\_utils.py", line 111, in inner
    return call(*args, **kwargs)
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\__init__.py", line 413, in exc_check
    raise retry_exc.reraise()
          ~~~~~~~~~~~~~~~~~^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\__init__.py", line 184, in reraise
    raise self.last_attempt.result()
          ~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 116, in __call__
    result = await fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\src\core\services.py", line 176, in _create_stream
    return await client.aio.models.generate_content_stream(
                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        model=payload.model,
        ^^^^^^^^^^^^^^^^^^^^
        contents=contents,
        ^^^^^^^^^^^^^^^^^^
        config=config,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1169, in __call__
    return self._mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1173, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1228, in _execute_mock_call
    raise effect
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 116, in __call__
    result = await fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\src\core\services.py", line 176, in _create_stream
    return await client.aio.models.generate_content_stream(
                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        model=payload.model,
        ^^^^^^^^^^^^^^^^^^^^
        contents=contents,
        ^^^^^^^^^^^^^^^^^^
        config=config,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1169, in __call__
    return self._mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1173, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1228, in _execute_mock_call
    raise effect
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 116, in __call__
    result = await fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\src\core\services.py", line 176, in _create_stream
    return await client.aio.models.generate_content_stream(
                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        model=payload.model,
        ^^^^^^^^^^^^^^^^^^^^
        contents=contents,
        ^^^^^^^^^^^^^^^^^^
        config=config,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1169, in __call__
    return self._mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1173, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1228, in _execute_mock_call
    raise effect
google.genai.errors.APIError: 500 None. {'message': 'Connection failed'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "E:\Python\syukatsu_Support\src\core\services.py", line 190, in _execute_api_call
    async with self.get_async_client() as client:
               ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 235, in __aexit__
    await self.gen.athrow(value)
  File "E:\Python\syukatsu_Support\src\core\base.py", line 61, in get_async_client
    await client.aio.aclose()
TypeError: object MagicMock can't be used in 'await' expression
____________ TestLLMService.test_stream_analysis_rate_limit_error _____________

self = <test_services.TestLLMService object at 0x000001C8176028B0>
service = <src.core.services.LLMService object at 0x000001C8175FAFD0>
mock_client = <MagicMock name='Client()' id='1958898182064'>
valid_payload = ResponseRequestPayload(model='gemini-3-pro-preview', input=[InputMessage(role='user', content=[InputTextContent(type='...text='Test input')])], instructions='System prompt', thinking=None, tools=None, previous_response_id=None, stream=True)

    @pytest.mark.asyncio
    async def test_stream_analysis_rate_limit_error(self, service, mock_client, valid_payload):
        """Verifies handling of Rate Limit errors."""
        mock_client.aio.models.generate_content_stream.side_effect = genai_errors.APIError(429, {"message": "Rate limit"})
    
        results = [res async for res in service.stream_analysis(valid_payload)]
    
        assert len(results) == 1
        assert isinstance(results[0], StreamError)
>       assert "利用制限エラー" in results[0].message
E       assert '利用制限エラー' in "\n[Stream Error] ストリーム処理中にエラーが発生しました: object MagicMock can't be used in 'await' expression"
E        +  where "\n[Stream Error] ストリーム処理中にエラーが発生しました: object MagicMock can't be used in 'await' expression" = StreamError(message="\n[Stream Error] ストリーム処理中にエラーが発生しました: object MagicMock can't be used in 'await' expression").message

tests\test_services.py:171: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  src.core.services:before_sleep.py:64 Retrying src.core.services.LLMService._create_stream in 0.53 seconds as it raised APIError: 429 None. {'message': 'Rate limit'}.
WARNING  src.core.services:before_sleep.py:64 Retrying src.core.services.LLMService._create_stream in 1.49 seconds as it raised APIError: 429 None. {'message': 'Rate limit'}.
ERROR    src.core.services:services.py:232 Error during stream iteration
Traceback (most recent call last):
  File "E:\Python\syukatsu_Support\src\core\base.py", line 58, in get_async_client
    yield client
  File "E:\Python\syukatsu_Support\src\core\services.py", line 191, in _execute_api_call
    stream = await self._create_stream(client, payload)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 193, in async_wrapped
    return await copy(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 112, in __call__
    do = await self.iter(retry_state=retry_state)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 157, in iter
    result = await action(retry_state)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\_utils.py", line 111, in inner
    return call(*args, **kwargs)
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\__init__.py", line 413, in exc_check
    raise retry_exc.reraise()
          ~~~~~~~~~~~~~~~~~^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\__init__.py", line 184, in reraise
    raise self.last_attempt.result()
          ~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 116, in __call__
    result = await fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\src\core\services.py", line 176, in _create_stream
    return await client.aio.models.generate_content_stream(
                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        model=payload.model,
        ^^^^^^^^^^^^^^^^^^^^
        contents=contents,
        ^^^^^^^^^^^^^^^^^^
        config=config,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1169, in __call__
    return self._mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1173, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1228, in _execute_mock_call
    raise effect
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 116, in __call__
    result = await fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\src\core\services.py", line 176, in _create_stream
    return await client.aio.models.generate_content_stream(
                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        model=payload.model,
        ^^^^^^^^^^^^^^^^^^^^
        contents=contents,
        ^^^^^^^^^^^^^^^^^^
        config=config,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1169, in __call__
    return self._mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1173, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1228, in _execute_mock_call
    raise effect
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 116, in __call__
    result = await fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\src\core\services.py", line 176, in _create_stream
    return await client.aio.models.generate_content_stream(
                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        model=payload.model,
        ^^^^^^^^^^^^^^^^^^^^
        contents=contents,
        ^^^^^^^^^^^^^^^^^^
        config=config,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1169, in __call__
    return self._mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1173, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1228, in _execute_mock_call
    raise effect
google.genai.errors.APIError: 429 None. {'message': 'Rate limit'}

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "E:\Python\syukatsu_Support\src\core\services.py", line 190, in _execute_api_call
    async with self.get_async_client() as client:
               ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 235, in __aexit__
    await self.gen.athrow(value)
  File "E:\Python\syukatsu_Support\src\core\base.py", line 61, in get_async_client
    await client.aio.aclose()
TypeError: object MagicMock can't be used in 'await' expression
___________ TestLLMService.test_stream_analysis_stream_error_event ____________

self = <test_services.TestLLMService object at 0x000001C817602780>
service = <src.core.services.LLMService object at 0x000001C817603950>
mock_client = <MagicMock name='Client()' id='1958898186432'>
valid_payload = ResponseRequestPayload(model='gemini-3-pro-preview', input=[InputMessage(role='user', content=[InputTextContent(type='...text='Test input')])], instructions='System prompt', thinking=None, tools=None, previous_response_id=None, stream=True)

    @pytest.mark.asyncio
    async def test_stream_analysis_stream_error_event(self, service, mock_client, valid_payload):
        """Verifies handling of an unexpected exception during the stream."""
        mock_client.aio.models.generate_content_stream.side_effect = Exception("Something went wrong mid-stream")
    
        results = [res async for res in service.stream_analysis(valid_payload)]
    
        assert len(results) == 1
        assert isinstance(results[0], StreamError)
>       assert "Something went wrong" in results[0].message
E       assert 'Something went wrong' in "\n[Stream Error] ストリーム処理中にエラーが発生しました: object MagicMock can't be used in 'await' expression"
E        +  where "\n[Stream Error] ストリーム処理中にエラーが発生しました: object MagicMock can't be used in 'await' expression" = StreamError(message="\n[Stream Error] ストリーム処理中にエラーが発生しました: object MagicMock can't be used in 'await' expression").message

tests\test_services.py:182: AssertionError
------------------------------ Captured log call ------------------------------
ERROR    src.core.services:services.py:232 Error during stream iteration
Traceback (most recent call last):
  File "E:\Python\syukatsu_Support\src\core\base.py", line 58, in get_async_client
    yield client
  File "E:\Python\syukatsu_Support\src\core\services.py", line 191, in _execute_api_call
    stream = await self._create_stream(client, payload)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 193, in async_wrapped
    return await copy(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 112, in __call__
    do = await self.iter(retry_state=retry_state)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 157, in iter
    result = await action(retry_state)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\_utils.py", line 111, in inner
    return call(*args, **kwargs)
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\__init__.py", line 393, in <lambda>
    self._add_action_func(lambda rs: rs.outcome.result())
                                     ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\concurrent\futures\_base.py", line 449, in result
    return self.__get_result()
           ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "E:\Python\syukatsu_Support\.venv\Lib\site-packages\tenacity\asyncio\__init__.py", line 116, in __call__
    result = await fn(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "E:\Python\syukatsu_Support\src\core\services.py", line 176, in _create_stream
    return await client.aio.models.generate_content_stream(
                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        model=payload.model,
        ^^^^^^^^^^^^^^^^^^^^
        contents=contents,
        ^^^^^^^^^^^^^^^^^^
        config=config,
        ^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1169, in __call__
    return self._mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1173, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py", line 1228, in _execute_mock_call
    raise effect
Exception: Something went wrong mid-stream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "E:\Python\syukatsu_Support\src\core\services.py", line 190, in _execute_api_call
    async with self.get_async_client() as client:
               ~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\contextlib.py", line 235, in __aexit__
    await self.gen.athrow(value)
  File "E:\Python\syukatsu_Support\src\core\base.py", line 61, in get_async_client
    await client.aio.aclose()
TypeError: object MagicMock can't be used in 'await' expression
=========================== short test summary info ===========================
FAILED tests/test_services.py::TestLLMService::test_stream_analysis_success
FAILED tests/test_services.py::TestLLMService::test_stream_analysis_api_connection_error
FAILED tests/test_services.py::TestLLMService::test_stream_analysis_rate_limit_error
FAILED tests/test_services.py::TestLLMService::test_stream_analysis_stream_error_event
4 failed, 3 passed in 5.71s
