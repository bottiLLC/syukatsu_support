============================= test session starts =============================
platform win32 -- Python 3.13.12, pytest-9.0.2, pluggy-1.6.0 -- E:\Python\syukatsu_Support\.venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: E:\Python\syukatsu_Support
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 63 items

tests/test_app_config.py::TestSecurityManager::test_encrypt_decrypt_cycle PASSED [  1%]
tests/test_app_config.py::TestSecurityManager::test_decrypt_invalid_token PASSED [  3%]
tests/test_app_config.py::TestUserConfig::test_defaults PASSED           [  4%]
tests/test_app_config.py::TestConfigManager::test_load_defaults_if_no_file PASSED [  6%]
tests/test_app_config.py::TestConfigManager::test_load_env_var_priority PASSED [  7%]
tests/test_app_config.py::TestConfigManager::test_save_and_load_encrypted PASSED [  9%]
tests/test_app_config.py::TestConfigManager::test_safety_defaults_enforced_on_load PASSED [ 11%]
tests/test_base.py::TestBaseGeminiService::test_init_success PASSED      [ 12%]
tests/test_base.py::TestBaseGeminiService::test_init_missing_key PASSED  [ 14%]
tests/test_dependencies.py::TestDependencyCheck::test_missing_package_exits_app FAILED [ 15%]
tests/test_dependencies.py::TestDependencyCheck::test_required_packages_list_integrity PASSED [ 17%]
tests/test_logging_config.py::test_setup_logging_calls_basic_config PASSED [ 19%]
tests/test_logging_config.py::test_logger_retrieval PASSED               [ 20%]
tests/test_main.py::TestMainApplication::test_main_success_path PASSED   [ 22%]
tests/test_main.py::TestMainApplication::test_main_startup_crash_handling PASSED [ 23%]
tests/test_main.py::TestMainApplication::test_main_crash_with_existing_root PASSED [ 25%]
tests/test_models.py::TestResponseRequestPayload::test_payload_normalization_string_input PASSED [ 26%]
tests/test_models.py::TestResponseRequestPayload::test_payload_explicit_list_input PASSED [ 28%]
tests/test_models.py::TestResponseRequestPayload::test_payload_with_tools PASSED [ 30%]
tests/test_models.py::TestResponseRequestPayload::test_payload_validation_failure PASSED [ 31%]
tests/test_models.py::TestStreamEvents::test_stream_text_delta PASSED    [ 33%]
tests/test_models.py::TestStreamEvents::test_stream_usage PASSED         [ 34%]
tests/test_models.py::TestStreamEvents::test_stream_error PASSED         [ 36%]
tests/test_mvp_presenters.py::test_main_presenter_initialization PASSED  [ 38%]
tests/test_mvp_presenters.py::test_main_presenter_start_generation PASSED [ 39%]
tests/test_mvp_presenters.py::test_rag_presenter_refresh PASSED          [ 41%]
tests/test_pricing.py::TestModelPricing::test_model_pricing_structure PASSED [ 42%]
tests/test_pricing.py::TestModelPricing::test_model_pricing_immutability PASSED [ 44%]
tests/test_pricing.py::TestModelPricing::test_default_cached_price PASSED [ 46%]
tests/test_pricing.py::TestPricingTable::test_table_integrity PASSED     [ 47%]
tests/test_pricing.py::TestPricingTable::test_essential_models_exist[gemini-3.1-pro] PASSED [ 49%]
tests/test_pricing.py::TestPricingTable::test_essential_models_exist[gemini-3-pro-preview] PASSED [ 50%]
tests/test_pricing.py::TestPricingTable::test_essential_models_exist[gemini-3-flash-preview] PASSED [ 52%]
tests/test_pricing.py::TestPricingTable::test_price_accuracy[gemini-3.1-pro-1.25-5.0-0.3125] PASSED [ 53%]
tests/test_pricing.py::TestPricingTable::test_price_accuracy[gemini-3-pro-preview-1.25-5.0-0.3125] PASSED [ 55%]
tests/test_pricing.py::TestPricingTable::test_price_accuracy[gemini-3-flash-preview-0.075-0.3-0.01875] PASSED [ 57%]
tests/test_pricing.py::TestPricingTable::test_pricing_sanity PASSED      [ 58%]
tests/test_prompts.py::test_prompts_structure PASSED                     [ 60%]
tests/test_prompts.py::test_prompts_keys_exist[\u6709\u4fa1\u8a3c\u5238\u5831\u544a\u66f8 -\u8ca1\u52d9\u5206\u6790-] PASSED [ 61%]
tests/test_prompts.py::test_prompts_keys_exist[\u6709\u4fa1\u8a3c\u5238\u5831\u544a\u66f8 -\u4eba\u7684\u8cc7\u672c\u5206\u6790-] PASSED [ 63%]
tests/test_prompts.py::test_prompts_keys_exist[\u5fd7\u671b\u52d5\u6a5f\u691c\u8a0e] PASSED [ 65%]
tests/test_prompts.py::test_prompts_content_integrity[\u6709\u4fa1\u8a3c\u5238\u5831\u544a\u66f8 -\u8ca1\u52d9\u5206\u6790--expected_keywords0] PASSED [ 66%]
tests/test_prompts.py::test_prompts_content_integrity[\u6709\u4fa1\u8a3c\u5238\u5831\u544a\u66f8 -\u4eba\u7684\u8cc7\u672c\u5206\u6790--expected_keywords1] PASSED [ 68%]
tests/test_prompts.py::test_prompts_content_integrity[\u5fd7\u671b\u52d5\u6a5f\u691c\u8a0e-expected_keywords2] PASSED [ 69%]
tests/test_prompts.py::test_prompts_contain_required_sections PASSED     [ 71%]
tests/test_prompts.py::test_default_config_key_exists_in_prompts PASSED  [ 73%]
tests/test_rag_services.py::TestFileService::test_upload_file_success PASSED [ 74%]
tests/test_rag_services.py::TestFileService::test_upload_file_not_found PASSED [ 76%]
tests/test_rag_services.py::TestFileService::test_delete_file PASSED     [ 77%]
tests/test_rag_services.py::TestVectorStoreService::test_create_vector_store PASSED [ 79%]
tests/test_rag_services.py::TestVectorStoreService::test_poll_batch_status_success PASSED [ 80%]
tests/test_services.py::TestCostCalculator::test_calculate_cost_with_valid_model PASSED [ 82%]
tests/test_services.py::TestCostCalculator::test_calculate_unknown_model_fallback PASSED [ 84%]
tests/test_services.py::TestCostCalculator::test_calculate_with_caching PASSED [ 85%]
tests/test_services.py::TestLLMService::test_stream_analysis_success PASSED [ 87%]
tests/test_services.py::TestLLMService::test_stream_analysis_api_connection_error PASSED [ 88%]
tests/test_services.py::TestLLMService::test_stream_analysis_rate_limit_error PASSED [ 90%]
tests/test_services.py::TestLLMService::test_stream_analysis_stream_error_event PASSED [ 92%]
tests/test_styles.py::test_window_size_format PASSED                     [ 93%]
tests/test_styles.py::test_ui_fonts_integrity PASSED                     [ 95%]
tests/test_styles.py::test_ui_colors_integrity PASSED                    [ 96%]
tests/test_types.py::test_reasoning_effort_values PASSED                 [ 98%]
tests/test_types.py::test_log_tag_values PASSED                          [100%]

================================== FAILURES ===================================
_____________ TestDependencyCheck.test_missing_package_exits_app ______________

self = <test_dependencies.TestDependencyCheck object at 0x000001D04F7C82D0>

    def test_missing_package_exits_app(self):
        """
        Verify that a missing package triggers an error dialog and sys.exit(1).
        """
        def mock_import_module_side_effect(name, *args, **kwargs):
            if name == "tenacity":
                raise ImportError("No module named 'tenacity'")
            return MagicMock()
    
        # Patch only the specific GUI call and exit to prevent real dialogs/exits
        with patch("src.config.dependencies.importlib.import_module", side_effect=mock_import_module_side_effect):
            with patch("src.config.dependencies._show_error_dialog") as mock_show_error:
                with patch("src.config.dependencies.logger") as mock_logger:
    
                    with pytest.raises(SystemExit) as excinfo:
                        check_dependencies()
    
                    assert excinfo.value.code == 1
    
                    # 1. Logged critical error
>                   mock_logger.critical.assert_called()

tests\test_dependencies.py:35: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock name='logger.critical' id='1994201650848'>

    def assert_called(self):
        """assert that the mock was called at least once
        """
        if self.call_count == 0:
            msg = ("Expected '%s' to have been called." %
                   (self._mock_name or 'mock'))
>           raise AssertionError(msg)
E           AssertionError: Expected 'critical' to have been called.

C:\Users\yoshi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:948: AssertionError
------------------------------ Captured log call ------------------------------
CRITICAL src.config.dependencies:dependencies.py:60 Missing dependencies: tenacity
============================== warnings summary ===============================
tests/test_services.py::TestLLMService::test_stream_analysis_api_connection_error
  E:\Python\syukatsu_Support\.venv\Lib\site-packages\google\genai\_api_client.py:765: DeprecationWarning: Inheritance class AiohttpClientSession from ClientSession is discouraged
    class AiohttpClientSession(aiohttp.ClientSession):  # type: ignore[misc]

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_dependencies.py::TestDependencyCheck::test_missing_package_exits_app
================== 1 failed, 62 passed, 1 warning in 10.81s ===================
